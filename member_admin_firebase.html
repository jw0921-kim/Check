
<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ì¶œì„ë¶€ ì¸ì› ê´€ë¦¬</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin-bottom: 20px;
    }
    select, input, button {
      font-size: 16px;
      padding: 6px;
      margin: 5px;
    }
    .log {
      margin-top: 20px;
      color: green;
    }
  </style>
</head>
<body>
<h1>ì¶œì„ë¶€ ì¸ì› ì¶”ê°€/ì‚­ì œ</h1>
<div>
<label>ë¶€ì„œ:
      <select id="department">
<option>ê²¸ì†ë¶€</option>
<option>ì˜¨ìœ ë¶€</option>
<option>ì‚¬ë‘ë¶€</option>
</select>
</label>
<label>ì„±ë³„:
      <select id="gender">
<option>í˜•ì œ</option>
<option>ìë§¤</option>
</select>
</label>
<input id="name" placeholder="ì´ë¦„ ì…ë ¥" type="text"/>
<input id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password"/>
<br/>
<button onclick="addPerson()">+ ì¶”ê°€</button>
<button onclick="removePerson()">ì‚­ì œ</button>
</div>
<h2>ì¸ì› ìˆœì„œ ë³€ê²½</h2>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<h2>ëª…ë‹¨ ë“œë˜ê·¸ë¡œ ìˆœì„œ ë³€ê²½</h2>
<div id="nameList" style="display:inline-block; text-align:left; margin: 10px auto; padding:10px; background:#fff; border:1px solid #ccc; min-width:180px;"></div>
<button onclick="applyDragOrder()">ğŸ’¾ ìˆœì„œ ì €ì¥</button>
<div>
<label>ê¸°ì¡´ ì¸ë±ìŠ¤ (0ë¶€í„°):
    <input id="fromIndex" style="width: 60px;" type="number"/>
</label>
<label>ì´ë™í•  ì¸ë±ìŠ¤:
    <input id="toIndex" style="width: 60px;" type="number"/>
</label>
<br/>
<input id="sortPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" type="password"/>
<button onclick="reorderNames()">ìˆœì„œ ë³€ê²½</button>
</div>
<div class="log" id="log"></div>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDrHDHrYO2Z8tWmWRgWYcN4nWHwALZ4c0s",
      authDomain: "attendance-6b1b6.firebaseapp.com",
      databaseURL: "https://attendance-6b1b6-default-rtdb.firebaseio.com",
      projectId: "attendance-6b1b6",
      storageBucket: "attendance-6b1b6.appspot.com",
      messagingSenderId: "808077953334",
      appId: "1:808077953334:web:238afede21744aee6f8b97"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    function getInputs() {
      const department = document.getElementById("department").value;
      const gender = document.getElementById("gender").value;
      const name = document.getElementById("name").value.trim();
      const pw = document.getElementById("password").value;
      return { department, gender, name, pw };
    }

    function logMessage(msg, color = "green") {
      const log = document.getElementById("log");
      log.style.color = color;
      log.textContent = msg;
    }

    function addPerson() {
      logMessage("ì¶”ê°€ ì¤‘...", "gray");
      const { department, gender, name, pw } = getInputs();
      if (pw !== "9191") return logMessage("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", "red");
      if (!name) return logMessage("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.", "red");

      const ref = db.ref(`attendance/${department}/ëª…ë‹¨/${gender}`);
      ref.once("value").then(snapshot => {
        const list = snapshot.val() || [];
        list.push(name);
        ref.set(list).then(() => {
          logMessage(`${name}ë‹˜ì´ ${department} ${gender}ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        });
      });
    }

    function removePerson() {
      logMessage("ì‚­ì œ ì¤‘...", "gray");
      const { department, gender, name, pw } = getInputs();
      if (pw !== "9191") return logMessage("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", "red");
      if (!name) return logMessage("ì‚­ì œí•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.", "red");

      const ref = db.ref(`attendance/${department}/ëª…ë‹¨/${gender}`);
      ref.once("value").then(snapshot => {
        let list = snapshot.val() || [];
        const index = list.indexOf(name);
        if (index === -1) return logMessage(`${name}ë‹˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`, "red");
        list.splice(index, 1);
        ref.set(list).then(() => {
          logMessage(`${name}ë‹˜ì´ ${department} ${gender}ì—ì„œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        });
      });
    }
  
function reorderNames() {
  const department = document.getElementById("department").value;
  const gender = document.getElementById("gender").value;
  const from = parseInt(document.getElementById("fromIndex").value);
  const to = parseInt(document.getElementById("toIndex").value);
  const pw = document.getElementById("sortPassword").value;
  if (pw !== "9191") return logMessage("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", "red");

  const nameRef = db.ref(`attendance/${department}/ëª…ë‹¨/${gender}`);
  nameRef.once("value").then(snapshot => {
    let nameList = snapshot.val() || [];
    if (from < 0 || from >= nameList.length || to < 0 || to >= nameList.length) {
      return logMessage("ì¸ë±ìŠ¤ê°€ ë²”ìœ„ë¥¼ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤.", "red");
    }

    const [moved] = nameList.splice(from, 1);
    nameList.splice(to, 0, moved);
    nameRef.set(nameList).then(() => {
      // ë‚ ì§œë³„ ì¶œì„ ì •ë³´ ìˆœì„œë„ ë™ì¼í•˜ê²Œ ë°”ê¿ˆ
      db.ref(`attendance/${department}`).once("value").then(fullSnap => {
        const updates = {};
        fullSnap.forEach(dateSnap => {
          const date = dateSnap.key;
          const attendanceList = dateSnap.val()?.[gender];
          if (Array.isArray(attendanceList)) {
            let reordered = [...attendanceList];
            const [val] = reordered.splice(from, 1);
            reordered.splice(to, 0, val);
            updates[`attendance/${department}/${date}/${gender}`] = reordered;
          }
        });

        db.ref().update(updates).then(() => {
          logMessage("ìˆœì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
      });
    });
  });
}

function loadAndRenderNames() {
  const department = document.getElementById("department").value;
  const gender = document.getElementById("gender").value;
  const listRef = db.ref(`attendance/${department}/ëª…ë‹¨/${gender}`);
  listRef.once("value").then(snapshot => {
    const list = snapshot.val() || [];
    const container = document.getElementById("nameList");
    container.innerHTML = "";
    list.forEach(name => {
      const div = document.createElement("div");
      div.textContent = name;
      div.className = "draggable";
      div.style.padding = "4px";
      div.style.border = "1px solid #ddd";
      div.style.margin = "2px 0";
      div.style.background = "#fafafa";
      container.appendChild(div);
    });
  });
}

function applyDragOrder() {
  const pw = prompt("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
  if (pw !== "9191") return logMessage("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.", "red");

  const department = document.getElementById("department").value;
  const gender = document.getElementById("gender").value;
  const container = document.getElementById("nameList");
  const newList = Array.from(container.children).map(div => div.textContent);

  db.ref(`attendance/${department}/ëª…ë‹¨/${gender}`).set(newList).then(() => {
    // ë‚ ì§œë³„ ì¶œì„ ìˆœì„œë„ ìˆ˜ì •
    db.ref(`attendance/${department}`).once("value").then(fullSnap => {
      const updates = {};
      fullSnap.forEach(dateSnap => {
        const date = dateSnap.key;
        const daily = dateSnap.val();
        const attendance = daily?.[gender];
        if (Array.isArray(attendance)) {
          const reordered = newList.map(name => {
            const oldList = daily[gender];
            const oldNamesRef = fullSnap.child("ëª…ë‹¨")?.val()?.[gender] || [];
            const idx = oldNamesRef.indexOf(name);
            return idx >= 0 ? oldList[idx] : false;
          });
          updates[`attendance/${department}/${date}/${gender}`] = reordered;
        }
      });
      db.ref().update(updates).then(() => {
        logMessage("ë“œë˜ê·¸ ìˆœì„œê°€ ì €ì¥ë˜ê³  ì¶œì„ ì •ë³´ë„ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
      });
    });
  });
}

// Init sortable
document.addEventListener("DOMContentLoaded", () => {
  new Sortable(nameList, {
    animation: 150
  });

  document.getElementById("department").addEventListener("change", loadAndRenderNames);
  document.getElementById("gender").addEventListener("change", loadAndRenderNames);
});
</script>
</body>
</html>
