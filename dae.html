<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>ì¶œì„ë¶€ Firebase ì—°ë™</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #e3f2fd 0%, #fff0f5 100%);
      margin: 0;
      padding: 16px;
      color: #333;
    }
    h1 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.4rem;
      color: #555;
    }
    .top-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }
    .top-controls button, .top-controls input {
      font-size: 14px;
      padding: 6px 10px;
      border-radius: 6px;
    }
    .summary {
      text-align: center;
      font-weight: 600;
      margin: 10px 0 18px;
      font-size: 0.95rem;
    }
    .group-container {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }
    .group {
      background: #ffffff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-width: 360px;
      flex: 1;
    }
    .group h2 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.1rem;
      color: #666;
    }
    .names {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }
    .name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      padding: 7px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.9rem;
      background: #f0f0f0;
    }
    .name.present {
      transform: scale(1.03);
      background: #e6f4ea;
      border: 2px solid #aed581;
      font-weight: bold;
      color: #33691e;
    }
    .bottom-controls {
      position: fixed;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 10px;
    }
    .bottom-controls button {
      background: #fff3e0;
      padding: 8px 12px;
      font-size: 13px;
      color: #6d4c41;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .copy-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #e8f5e9;
      padding: 8px 12px;
      font-size: 14px;
      color: #2e7d32;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    .copy-btn:hover {
      background: #c8e6c9;
    }
    .back-btn {
      position: absolute;
      top: 12px;
      left: 12px;
      background: #f3f7ff;
      color: #37474f;
      border: 1px solid #cfd8dc;
      padding: 6px 12px;
      font-size: 13px;
      border-radius: 6px;
      cursor: pointer;
    }
    .toast {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #323232;
      color: #fff;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.3s ease;
      z-index: 9999;
      pointer-events: none;
    }
  </style>
</head>
<body>
<button class="back-btn" onclick="history.back()">â† ë’¤ë¡œê°€ê¸°</button>
<h1>ğŸ“‹ ëŒ€í•™ë¶€</h1>
<div class="top-controls">
<button id="prevDay">â—€</button>
<input id="datePicker" type="text"/>
<button id="nextDay">â–¶</button>
</div>
<div class="summary" id="summary">ì´ ì¶œì„: 0ëª…</div>
<div class="group-container">
<div class="group">
<h2>í˜•ì œ <span id="broCount"></span></h2>
<div class="names" id="brothers"></div>
</div>
<div class="group">
<h2>ìë§¤ <span id="sisCount"></span></h2>
<div class="names" id="sisters"></div>
</div>
</div>
<div class="bottom-controls">
<button id="clearAllBtn">ì „ì²´ ì„ íƒ í•´ì œ</button>
<button id="undoBtn">ë˜ëŒë¦¬ê¸°</button>
<button id="redoBtn">ë‹¤ì‹œ ì‹¤í–‰</button>
</div>
<button class="copy-btn" id="copyBtn">ë³µì‚¬</button>
<div class="toast" id="toast">í´ë¦½ë³´ë“œì— ë³µì‚¬ë¨!</div>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDrHDHrYO2Z8tWmWRgWYcN4nWHwALZ4c0s",
      authDomain: "attendance-6b1b6.firebaseapp.com",
      databaseURL: "https://attendance-6b1b6-default-rtdb.firebaseio.com",
      projectId: "attendance-6b1b6",
      storageBucket: "attendance-6b1b6.appspot.com",
      messagingSenderId: "808077953334",
      appId: "1:808077953334:web:238afede21744aee6f8b97"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let brothers = [], sisters = [], currentDate = new Date().toISOString().split("T")[0];
    const datePicker = document.getElementById("datePicker"), summary = document.getElementById("summary");
    const broCountEl = document.getElementById("broCount"), sisCountEl = document.getElementById("sisCount");
    const brothersDiv = document.getElementById("brothers"), sistersDiv = document.getElementById("sisters");
    let undoStack = [], redoStack = [];
    function getCurrentState() {
      return {
        í˜•ì œ: brothers.map((_, i) => brothersDiv.children[i].classList.contains("present")),
        ìë§¤: sisters.map((_, i) => sistersDiv.children[i].classList.contains("present"))
      };
    }
    function applyState(state) {
      state.í˜•ì œ.forEach((v, i) => brothersDiv.children[i]?.classList.toggle("present", v));
      state.ìë§¤.forEach((v, i) => sistersDiv.children[i]?.classList.toggle("present", v));
      updateSummary(); saveToFirebase();
    }
    function pushUndoState() { undoStack.push(getCurrentState()); redoStack = []; }
    function createTag(name) {
      const div = document.createElement("div");
      div.className = "name"; div.textContent = name;
      div.onclick = () => {
        pushUndoState(); div.classList.toggle("present");
        updateSummary(); saveToFirebase();
      };
      return div;
    }
    function fetchNames() {
      return db.ref("attendance/ëŒ€í•™ë¶€/ëª…ë‹¨").get().then(snap => {
        const data = snap.val() || {};
        brothers = data.í˜•ì œ || []; sisters = data.ìë§¤ || [];
      });
    }
    function render() {
      brothersDiv.innerHTML = ""; sistersDiv.innerHTML = "";
      brothers.forEach(name => brothersDiv.appendChild(createTag(name)));
      sisters.forEach(name => sistersDiv.appendChild(createTag(name)));
    }
    function updateSummary() {
      const b = [...brothersDiv.children].filter(c => c.classList.contains("present")).length;
      const s = [...sistersDiv.children].filter(c => c.classList.contains("present")).length;
      summary.textContent = `ì´ ì¶œì„: ${b + s}ëª…`;
      broCountEl.textContent = b ? `${b}ëª…` : ""; sisCountEl.textContent = s ? `${s}ëª…` : "";
    }
    function saveToFirebase() {
      const bro = brothers.map((_, i) => brothersDiv.children[i].classList.contains("present"));
      const sis = sisters.map((_, i) => sistersDiv.children[i].classList.contains("present"));
      db.ref(`attendance/ëŒ€í•™ë¶€/${currentDate}`).set({ í˜•ì œ: bro, ìë§¤: sis });
    }
    function listenToFirebase() {
      db.ref(`attendance/ëŒ€í•™ë¶€/${currentDate}`).on("value", snap => {
        if (!snap.exists()) return updateSummary();
        const data = snap.val();
        brothers.forEach((_, i) => {
          brothersDiv.children[i]?.classList.toggle("present", !!data.í˜•ì œ?.[i]);
        });
        sisters.forEach((_, i) => {
          sistersDiv.children[i]?.classList.toggle("present", !!data.ìë§¤?.[i]);
        });
        updateSummary();
      });
    }
    function changeDate(offset) {
      undoStack = []; redoStack = [];
      db.ref(`attendance/ëŒ€í•™ë¶€/${currentDate}`).off();
      const d = new Date(currentDate); d.setDate(d.getDate() + offset);
      currentDate = d.toISOString().split("T")[0];
      datePicker._flatpickr.setDate(currentDate, true);
      fetchNames().then(() => { render(); listenToFirebase(); });
    }
    document.getElementById("prevDay").onclick = () => changeDate(-1);
    document.getElementById("nextDay").onclick = () => changeDate(1);
    document.getElementById("clearAllBtn").onclick = () => {
      pushUndoState(); [...brothersDiv.children].forEach(c => c.classList.remove("present"));
      [...sistersDiv.children].forEach(c => c.classList.remove("present"));
      updateSummary(); saveToFirebase();
    };
    document.getElementById("undoBtn").onclick = () => {
      if (!undoStack.length) return showToast("ë˜ëŒë¦´ ì‘ì—…ì´ ì—†ì–´ìš”");
      redoStack.push(getCurrentState()); applyState(undoStack.pop()); showToast("ë˜ëŒë ¸ì–´ìš”");
    };
    document.getElementById("redoBtn").onclick = () => {
      if (!redoStack.length) return showToast("ë‹¤ì‹œ ì‹¤í–‰í•  ì‘ì—…ì´ ì—†ì–´ìš”");
      undoStack.push(getCurrentState()); applyState(redoStack.pop()); showToast("ë‹¤ì‹œ ì‹¤í–‰í–ˆì–´ìš”");
    };
document.getElementById('copyBtn').onclick = () => {
  const date = new Date(currentDate);
  const yy = String(date.getFullYear()).slice(2);
  const mm = String(date.getMonth() + 1).padStart(2, '0');
  const dd = String(date.getDate()).padStart(2, '0');
  const days = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '];
  const dow = days[date.getDay()];
  let h1Text = document.querySelector('h1').textContent;
  let deptMatch = h1Text.match(/([ê°€-í£]+ë¶€)/);
  let dept = deptMatch ? deptMatch[1] : '';
  const header = `â˜˜ï¸${yy}.${mm}.${dd} (${dow}) ${dept} ì¶œì„â˜˜ï¸`;

  let broNames = [...brothersDiv.children].filter(c=>c.classList.contains('present')).map(c=>c.textContent);
  let sisNames = [...sistersDiv.children].filter(c=>c.classList.contains('present')).map(c=>c.textContent);

  const freshmen = ['ê¹€ë„ê±´', 'ê¹€ì§„ìš°', 'ê¹€ë‘í˜„', 'ì˜¤ì„œì¤€', 'í•œê°€ì€', 'ì´ë‹¤ì—°'];
  let freshNames = [...broNames, ...sisNames].filter(n => freshmen.includes(n));
  broNames = broNames.filter(n => !freshNames.includes(n));
  sisNames = sisNames.filter(n => !freshNames.includes(n));

  const formatList = list => list.map((v, i) => (i && i % 5 === 0 ? '\n' : '') + v).join(', ');

  let text = `${header}\n\n`;
  if (broNames.length) text += `í˜•ì œë‹˜ğŸ™‹ğŸ»â€â™‚ï¸\n\n${formatList(broNames)}\n\n`;
  if (sisNames.length) text += `ìë§¤ë‹˜ğŸ™‹ğŸ»â€â™€ï¸\n\n${formatList(sisNames)}\n\n`;
  if (freshNames.length) text += `ğŸ’›ì‹ ì…ìƒğŸ’›\n\n${formatList(freshNames)}\n\n`;

  if (broNames.length) text += `í˜•ì œë‹˜: ${broNames.length}ëª…\n`;
  if (sisNames.length) text += `ìë§¤ë‹˜: ${sisNames.length}ëª…\n`;
  if (freshNames.length) text += `ì‹ ì…ìƒ: ${freshNames.length}ëª…\n\n`;

  text += `ì´ â€œ${broNames.length + sisNames.length + freshNames.length}ëª…â€ ì°¸ì„í•˜ì˜€ìŠµë‹ˆë‹¤`;

  navigator.clipboard.writeText(text).then(() => showToast('ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤'));
};
    flatpickr(datePicker, {
      locale: "ko", dateFormat: "Y-m-d", defaultDate: currentDate,
      onChange: (_, dateStr) => {
        db.ref(`attendance/ëŒ€í•™ë¶€/${currentDate}`).off(); render();
        currentDate = dateStr; fetchNames().then(() => { render(); listenToFirebase(); });
      }
    });
    fetchNames().then(() => { render(); listenToFirebase(); });
    function showToast(msg) {
      const toast = document.getElementById("toast");
      toast.textContent = msg; toast.style.opacity = 1;
      setTimeout(() => toast.style.opacity = 0, 2000);
    }
  </script>
</body>
</html>
