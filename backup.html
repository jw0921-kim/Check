
<!-- NOTE: This is a partial backup implementation base template.
     JavaScript logic should be extended further in attendance-specific pages. -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>관리자 백업/복원 테스트</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body style="font-family: sans-serif; padding: 20px;">
  <h2>관리자 백업 및 복원 테스트</h2>
  <div>
    <select id="departmentSelect">
      <option>겸손부</option>
      <option>온유부</option>
      <option>사랑부</option>
    </select>
    <select id="genderSelect">
      <option>형제</option>
      <option>자매</option>
    </select>
    <input type="date" id="dateSelect" />
    <button onclick="restoreBackup()">이 날짜로 복원</button>
  </div>
  <pre id="statusLog" style="margin-top: 20px; background: #eee; padding: 10px;"></pre>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDrHDHrYO2Z8tWmWRgWYcN4nWHwALZ4c0s",
  authDomain: "attendance-6b1b6.firebaseapp.com",
  databaseURL: "https://attendance-6b1b6-default-rtdb.firebaseio.com",
  projectId: "attendance-6b1b6",
  storageBucket: "attendance-6b1b6.appspot.com",
  messagingSenderId: "808077953334",
  appId: "1:808077953334:web:238afede21744aee6f8b97"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function log(msg) {
  document.getElementById("statusLog").textContent += msg + "\n";
}

function restoreBackup() {
  const dep = document.getElementById("departmentSelect").value;
  const gender = document.getElementById("genderSelect").value;
  const date = document.getElementById("dateSelect").value;
  if (!date) return alert("날짜를 선택하세요.");

  const datePrefix = date;
  const path = `attendance_backup/${dep}/${gender}`;

  db.ref(path).get().then(snap => {
    const backups = snap.val() || {};
    const keys = Object.keys(backups).filter(k => k.startsWith(datePrefix));
    if (keys.length === 0) {
      log(`[${date}]에 해당하는 백업 없음`);
      return;
    }
    const latestKey = keys.sort().reverse()[0];  // 가장 마지막 백업 사용
    const data = backups[latestKey];
    if (!data.names || !data.attendance) {
      log("백업 데이터에 이름 또는 출석 정보 없음");
      return;
    }

    // 복원: 이름 명단
    db.ref(`attendance/${dep}/명단/${gender}`).set(data.names).then(() => {
      log(`[${dep}/${gender}] 이름 명단 복원 완료`);
    });

    // 복원: 출석 정보
    Object.entries(data.attendance).forEach(([day, attendanceMap]) => {
      db.ref(`attendance/${dep}/출석/${gender}/${day}`).set(attendanceMap).then(() => {
        log(`[${dep}/${gender}] ${day} 출석 복원 완료`);
      });
    });
  });
}
</script>
</body>
</html>
