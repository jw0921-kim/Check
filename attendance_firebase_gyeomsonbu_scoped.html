<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>ì¶œì„ë¶€ Firebase ì—°ë™</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
  <style>
    /* ê¸°ì¡´ CSS ê·¸ëŒ€ë¡œ ìœ ì§€ (ìƒëµ) */
  </style>
</head>
<body>
  <button class="back-btn" onclick="history.back()">â† ë’¤ë¡œê°€ê¸°</button>

  <h1>ğŸ“‹ ê²¸ì†ë¶€</h1>
  <div class="top-controls">
    <button id="prevDay">â—€</button>
    <input id="datePicker" type="text"/>
    <button id="nextDay">â–¶</button>
  </div>
  <div class="summary" id="summary">ì´ ì¶œì„: 0ëª…</div>
  <div class="group-container">
    <div class="group">
      <h2>í˜•ì œ <span id="broCount"></span></h2>
      <div class="names" id="brothers"></div>
    </div>
    <div class="group">
      <h2>ìë§¤ <span id="sisCount"></span></h2>
      <div class="names" id="sisters"></div>
    </div>
  </div>
  <div class="bottom-controls">
    <button id="clearAllBtn">ì „ì²´ ì„ íƒ í•´ì œ</button>
    <button id="undoBtn">ë˜ëŒë¦¬ê¸°</button>
    <button id="redoBtn">ë‹¤ì‹œ ì‹¤í–‰</button>
  </div>
  <button id="copyBtn">ë³µì‚¬</button>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDrHDHrYO2Z8tWmWRgWYcN4nWHwALZ4c0s",
      authDomain: "attendance-6b1b6.firebaseapp.com",
      databaseURL: "https://attendance-6b1b6-default-rtdb.firebaseio.com",
      projectId: "attendance-6b1b6",
      storageBucket: "attendance-6b1b6.appspot.com",
      messagingSenderId: "808077953334",
      appId: "1:808077953334:web:238afede21744aee6f8b97"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const brothers = ["ì´íƒœì„­", "ê¹€ì§„ìš°", "ì´ë™í™˜", "ê¹€ì§€ì„", "ì „ë„ì˜", "ê¹€ê¶Œë¹„", "ê¹€ë¯¼í˜¸", "ë‚¨ì¤€í˜", "ìµœì¬í˜", "ê¹€ì¸ìˆ˜", "ë¬¸ì§€í›ˆ", "ì „í˜¸ì„±", "ë°•ì§€ì›…", "ê¹€ë‘í˜„", "ë°•íš¨ì›"];
    const sisters = ["ì „íš¨ì§„", "ê³ ë‹¤ì˜", "ë‚¨ì†Œì—°", "ê¹€ìœ ë‚˜", "ì •ì—¬ì§„", "ì‹¬ê·œë¦¬", "ê¹€ë¯¼ì„œ", "ë°•ì§€í˜œ", "ì‹¬ì¬ê²½", "ìœ ì§€ì—°", "ì‹¬ì˜ˆë¦¼", "ì´ì†Œí¬", "ì„ë„í•´", "ì´í˜„í™”", "ê¹€ì†Œì€", "ê¹€ì´ì•ˆ"];
    let currentDate = new Date().toISOString().split("T")[0];

    const datePicker = document.getElementById("datePicker");
    const summary = document.getElementById("summary");
    const broCountEl = document.getElementById("broCount");
    const sisCountEl = document.getElementById("sisCount");
    const brothersDiv = document.getElementById("brothers");
    const sistersDiv = document.getElementById("sisters");

    let undoStack = [];
    let redoStack = [];
    let firebaseRef = null;

    function getCurrentState() {
      return {
        í˜•ì œ: brothers.map((_, i) => brothersDiv.children[i].classList.contains("present")),
        ìë§¤: sisters.map((_, i) => sistersDiv.children[i].classList.contains("present"))
      };
    }

    function applyState(state) {
      state.í˜•ì œ.forEach((v, i) => brothersDiv.children[i]?.classList.toggle("present", v));
      state.ìë§¤.forEach((v, i) => sistersDiv.children[i]?.classList.toggle("present", v));
      updateSummary();
    }

    function pushUndoState() {
      undoStack.push(getCurrentState());
      redoStack = [];
    }

    function createTag(name) {
      const div = document.createElement("div");
      div.className = "name";
      div.textContent = name;
      div.onclick = () => {
        pushUndoState();
        div.classList.toggle("present");
        updateSummary();
        saveToFirebase();
      };
      return div;
    }

    function render() {
      brothersDiv.innerHTML = "";
      sistersDiv.innerHTML = "";
      brothers.forEach(name => brothersDiv.appendChild(createTag(name)));
      sisters.forEach(name => sistersDiv.appendChild(createTag(name)));
    }

    function updateSummary() {
      const b = [...brothersDiv.children].filter(c => c.classList.contains("present")).length;
      const s = [...sistersDiv.children].filter(c => c.classList.contains("present")).length;
      summary.textContent = `ì´ ì¶œì„: ${b + s}ëª…`;
      broCountEl.textContent = b ? `${b}ëª…` : "";
      sisCountEl.textContent = s ? `${s}ëª…` : "";
    }

    function saveToFirebase() {
      const bro = brothers.map((_, i) => brothersDiv.children[i].classList.contains("present"));
      const sis = sisters.map((_, i) => sistersDiv.children[i].classList.contains("present"));
      db.ref("attendance/ê²¸ì†ë¶€/" + currentDate).set({ í˜•ì œ: bro, ìë§¤: sis });
    }

    function watchRealtime() {
      if (firebaseRef) firebaseRef.off(); // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
      firebaseRef = db.ref("attendance/ê²¸ì†ë¶€/" + currentDate);
      firebaseRef.on("value", (snap) => {
        render();
        if (!snap.exists()) return updateSummary();
        const data = snap.val();
        if (data.í˜•ì œ) data.í˜•ì œ.forEach((v, i) => brothersDiv.children[i]?.classList.toggle("present", v));
        if (data.ìë§¤) data.ìë§¤.forEach((v, i) => sistersDiv.children[i]?.classList.toggle("present", v));
        updateSummary();
      });
    }

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add("show"), 10);
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => document.body.removeChild(toast), 500);
      }, 2000);
    }

    document.getElementById("copyBtn").onclick = () => {
      const yy = currentDate.slice(2,4), mm = currentDate.slice(5,7), dd = currentDate.slice(8,10);
      const wd = ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '][new Date(currentDate).getDay()];
      const bro = [...brothersDiv.children].filter(c => c.classList.contains("present")).map(c => c.textContent);
      const sis = [...sistersDiv.children].filter(c => c.classList.contains("present")).map(c => c.textContent);
      const lines = [`${yy}.${mm}.${dd}(${wd}) ê²¸ì†ë¶€ ì´ ${bro.length + sis.length}ëª…`];
      lines.push(`í˜•ì œë‹˜ ${bro.length}ëª…`);
      for (let i=0; i<bro.length; i+=5) lines.push(bro.slice(i,i+5).join(" "));
      lines.push(``, `ìë§¤ë‹˜ ${sis.length}ëª…`);
      for (let i=0; i<sis.length; i+=5) lines.push(sis.slice(i,i+5).join(" "));
      navigator.clipboard.writeText(lines.join("\n")).then(() => showToast("ì¶œì„ í˜„í™© ë³µì‚¬ë¨!"));
    };

    document.getElementById("prevDay").onclick = () => changeDate(-1);
    document.getElementById("nextDay").onclick = () => changeDate(1);
    document.getElementById("clearAllBtn").onclick = () => {
      pushUndoState();
      [...brothersDiv.children].forEach(c => c.classList.remove("present"));
      [...sistersDiv.children].forEach(c => c.classList.remove("present"));
      updateSummary();
      saveToFirebase();
    };
    document.getElementById("undoBtn").onclick = () => {
      if (undoStack.length === 0) return showToast("ë˜ëŒë¦´ ì‘ì—…ì´ ì—†ì–´ìš”!");
      redoStack.push(getCurrentState());
      const prev = undoStack.pop();
      applyState(prev);
      saveToFirebase();
      showToast("ë˜ëŒë ¸ì–´ìš”!");
    };
    document.getElementById("redoBtn").onclick = () => {
      if (redoStack.length === 0) return showToast("ë‹¤ì‹œ ì‹¤í–‰í•  ì‘ì—…ì´ ì—†ì–´ìš”!");
      undoStack.push(getCurrentState());
      const next = redoStack.pop();
      applyState(next);
      saveToFirebase();
      showToast("ë‹¤ì‹œ ì‹¤í–‰í–ˆì–´ìš”!");
    };

    function changeDate(offset) {
      const d = new Date(currentDate);
      d.setDate(d.getDate() + offset);
      currentDate = d.toISOString().split("T")[0];
      datePicker._flatpickr.setDate(currentDate, true);
      watchRealtime();
    }

    flatpickr(datePicker, {
      locale: "ko",
      dateFormat: "Y-m-d",
      defaultDate: currentDate,
      onChange: (_, dateStr) => {
        currentDate = dateStr;
        watchRealtime();
      }
    });

    watchRealtime();
  </script>
</body>
</html>
