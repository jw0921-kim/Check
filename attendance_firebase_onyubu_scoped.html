<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Ï∂úÏÑùÎ∂Ä Firebase Ïó∞Îèô</title>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #e3f2fd 0%, #fff0f5 100%);
      margin: 0;
      padding: 16px;
      color: #333;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.4rem;
      color: #555;
    }

    .top-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .top-controls button {
      font-size: 14px;
      padding: 6px 10px;
      background: #f1fafe;
      border: none;
      color: #004d40;
      border-radius: 6px;
      cursor: pointer;
    }

    .top-controls input {
      font-size: 14px;
      padding: 6px;
      width: 130px;
      text-align: center;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .summary {
      text-align: center;
      font-weight: 600;
      margin: 10px 0 18px;
      font-size: 0.95rem;
    }

    .group-container {
      display: flex;
      gap: 16px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .group {
      background: #ffffff;
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      max-width: 360px;
      flex: 1;
    }

    .group h2 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.1rem;
      color: #666;
    }

    .group h2 span {
      font-size: 0.85rem;
      color: #999;
      margin-left: 6px;
    }

    .names {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    #brothers { background: linear-gradient(to bottom, #e3f2fd, #ffffff); border-radius: 14px; padding: 12px; }
#brothers .name {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 6px 4px;
      background: #e3f2fd;
      color: #0d47a1;
      border: 1px solid #bbdefb;
    }

    #sisters { background: linear-gradient(to bottom, #fce4ec, #ffffff); border-radius: 14px; padding: 12px; }
#sisters .name {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 6px 4px;
      background: #fce4ec;
      color: #880e4f;
      border: 1px solid #f8bbd0;
    }

    
.name {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 7px;
  text-align: center;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  justify-content: center;
}

.name span {
  display: inline-block;
  max-width: 100%;
  font-size: inherit;
  transform: scaleX(1);
  letter-spacing: -0.5px;
}


.name.present {
  transform: scale(1.03);
  transition: transform 0.2s ease;
  color: #2e7d32 !important;
  background: #e6f4ea !important;
  border: 2px solid #aed581;
  font-weight: bold;
  color: #33691e;
}

    .toast {
      position: fixed;
      bottom: 60px;
      right: 20px;
      background: rgba(0,0,0,0.75);
      color: #fff;
      padding: 8px 12px;
      border-radius: 4px;
      opacity: 0;
      transition: opacity 0.5s ease;
      font-size: 0.85rem;
    }

    .toast.show {
      opacity: 1;
    }

    #copyBtn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 8px 14px;
      background: #fceefc;
      color: #4a148c;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .bottom-controls {
      position: fixed;
      bottom: 20px;
      left: 20px;
      display: flex;
      gap: 10px;
    }

    .bottom-controls button {
      background: #fff3e0;
      padding: 8px 12px;
      font-size: 13px;
      color: #6d4c41;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      box-sizing: border-box;
    }
    
        .back-btn {
          position: absolute;
          top: 12px;
          left: 12px;
          background: #f3f7ff;
          color: #37474f;
          border: 1px solid #cfd8dc;
          padding: 6px 12px;
          font-size: 13px;
          border-radius: 6px;
          cursor: pointer;
          box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        </style>
</head>
<body>
<button class="back-btn" onclick="history.back()">‚Üê Îí§Î°úÍ∞ÄÍ∏∞</button>

<h1>üìã Ïò®Ïú†Î∂Ä</h1>
<div class="top-controls">
<button id="prevDay">‚óÄ</button>
<input id="datePicker" type="text"/>
<button id="nextDay">‚ñ∂</button>
</div>
<div class="summary" id="summary">Ï¥ù Ï∂úÏÑù: 0Î™Ö</div>
<div class="group-container">
<div class="group">
<h2>ÌòïÏ†ú <span id="broCount"></span></h2>
<div class="names" id="brothers"></div>
</div>
<div class="group">
<h2>ÏûêÎß§ <span id="sisCount"></span></h2>
<div class="names" id="sisters"></div>
</div>
</div>
<div class="bottom-controls">
<button id="clearAllBtn">Ï†ÑÏ≤¥ ÏÑ†ÌÉù Ìï¥Ï†ú</button>
<button id="undoBtn">ÎêòÎèåÎ¶¨Í∏∞</button>
<button id="redoBtn">Îã§Ïãú Ïã§Ìñâ</button>
</div>
<button id="copyBtn">Î≥µÏÇ¨</button>
<script>
    const firebaseConfig = {
      apiKey: "AIzaSyDrHDHrYO2Z8tWmWRgWYcN4nWHwALZ4c0s",
      authDomain: "attendance-6b1b6.firebaseapp.com",
      databaseURL: "https://attendance-6b1b6-default-rtdb.firebaseio.com",
      projectId: "attendance-6b1b6",
      storageBucket: "attendance-6b1b6.appspot.com",
      messagingSenderId: "808077953334",
      appId: "1:808077953334:web:238afede21744aee6f8b97"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let brothers = [];
    let sisters = [];
    let currentDate = new Date().toISOString().split("T")[0];

    const datePicker = document.getElementById("datePicker");
    const summary = document.getElementById("summary");
    const broCountEl = document.getElementById("broCount");
    const sisCountEl = document.getElementById("sisCount");
    const brothersDiv = document.getElementById("brothers");
    const sistersDiv = document.getElementById("sisters");

    let undoStack = [];
    let redoStack = [];

    function getCurrentState() {
      return {
        ÌòïÏ†ú: brothers.map((_, i) => brothersDiv.children[i].classList.contains("present")),
        ÏûêÎß§: sisters.map((_, i) => sistersDiv.children[i].classList.contains("present"))
      };
    }

    function applyState(state) {
      state.ÌòïÏ†ú.forEach((v, i) => brothersDiv.children[i]?.classList.toggle("present", v));
      state.ÏûêÎß§.forEach((v, i) => sistersDiv.children[i]?.classList.toggle("present", v));
      updateSummary();
      saveToFirebase();
    }

    function pushUndoState() {
      undoStack.push(getCurrentState());
      redoStack = [];
    }

    function createTag(name) {
      const div = document.createElement("div");
      div.className = "name";
      div.innerHTML = `<span>${name}</span>`;
      div.onclick = () => {
        pushUndoState();
        div.classList.toggle("present");
        updateSummary();
        saveToFirebase();
      };
      return div;
    }

    
function fetchNames() {
  return db.ref("attendance/Ïò®Ïú†Î∂Ä/Î™ÖÎã®").get().then(snap => {
    const data = snap.val() || {};
    brothers = data.ÌòïÏ†ú || [];
    sisters = data.ÏûêÎß§ || [];
  });
}

function render() {
      brothersDiv.innerHTML = "";
      sistersDiv.innerHTML = "";
      brothers.forEach(name => brothersDiv.appendChild(createTag(name)));
      sisters.forEach(name => sistersDiv.appendChild(createTag(name)));
    }

    function updateSummary() {
      const b = [...brothersDiv.children].filter(c => c.classList.contains("present")).length;
      const s = [...sistersDiv.children].filter(c => c.classList.contains("present")).length;
      summary.textContent = `Ï¥ù Ï∂úÏÑù: ${b + s}Î™Ö`;
      broCountEl.textContent = b ? `${b}Î™Ö` : "";
      sisCountEl.textContent = s ? `${s}Î™Ö` : "";
    }

    function saveToFirebase() {
      const bro = brothers.map((_, i) => brothersDiv.children[i].classList.contains("present"));
      const sis = sisters.map((_, i) => sistersDiv.children[i].classList.contains("present"));
      db.ref("attendance/Ïò®Ïú†Î∂Ä/" + currentDate).set({ ÌòïÏ†ú: bro, ÏûêÎß§: sis });
    }

    
    function listenToFirebase() {
      db.ref("attendance/Ïò®Ïú†Î∂Ä/" + currentDate).on("value", snap => {
        if (!snap.exists()) return updateSummary();
        const data = snap.val();
        brothers.forEach((_, i) => {
          brothersDiv.children[i]?.classList.toggle("present", !!data.ÌòïÏ†ú?.[i]);
        });
        sisters.forEach((_, i) => {
          sistersDiv.children[i]?.classList.toggle("present", !!data.ÏûêÎß§?.[i]);
        });
        updateSummary();
      });
    }

function loadFromFirebase() {
      render();
      db.ref("attendance/Ïò®Ïú†Î∂Ä/" + currentDate).get().then(snap => {
        if (!snap.exists()) return updateSummary();
        const data = snap.val();
        if (data.ÌòïÏ†ú) data.ÌòïÏ†ú.forEach((v,i) => brothersDiv.children[i]?.classList.toggle("present", v));
        if (data.ÏûêÎß§) data.ÏûêÎß§.forEach((v,i) => sistersDiv.children[i]?.classList.toggle("present", v));
        updateSummary();
      });
    }

    function showToast(message) {
      const toast = document.createElement("div");
      toast.className = "toast";
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.classList.add("show"), 10);
      setTimeout(() => {
        toast.classList.remove("show");
        setTimeout(() => document.body.removeChild(toast), 500);
      }, 2000);
    }

    document.getElementById("copyBtn").onclick = () => {
      const yy = currentDate.slice(2,4), mm = currentDate.slice(5,7), dd = currentDate.slice(8,10);
      const wd = ['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'][new Date(currentDate).getDay()];
      const bro = [...brothersDiv.children].filter(c => c.classList.contains("present")).map(c => c.textContent);
      const sis = [...sistersDiv.children].filter(c => c.classList.contains("present")).map(c => c.textContent);
      const lines = [`${yy}.${mm}.${dd}(${wd}) Ïò®Ïú†Î∂Ä Ï¥ù ${bro.length + sis.length}Î™Ö`];
      lines.push(`ÌòïÏ†úÎãò ${bro.length}Î™Ö`);
      for (let i=0; i<bro.length; i+=5) lines.push(bro.slice(i,i+5).join(" "));
      lines.push(``, `ÏûêÎß§Îãò ${sis.length}Î™Ö`);
      for (let i=0; i<sis.length; i+=5) lines.push(sis.slice(i,i+5).join(" "));
      navigator.clipboard.writeText(lines.join("\n")).then(() => showToast("Ï∂úÏÑù ÌòÑÌô© Î≥µÏÇ¨Îê®!"));
    };

    document.getElementById("prevDay").onclick = () => changeDate(-1);
    document.getElementById("nextDay").onclick = () => changeDate(1);
    document.getElementById("clearAllBtn").onclick = () => {
      pushUndoState();
      [...brothersDiv.children].forEach(c => c.classList.remove("present"));
      [...sistersDiv.children].forEach(c => c.classList.remove("present"));
      updateSummary();
      saveToFirebase();
    };
    document.getElementById("undoBtn").onclick = () => {
      if (undoStack.length === 0) return showToast("ÎêòÎèåÎ¶¥ ÏûëÏóÖÏù¥ ÏóÜÏñ¥Ïöî!");
      redoStack.push(getCurrentState());
      const prev = undoStack.pop();
      applyState(prev);
      showToast("ÎêòÎèåÎ†∏Ïñ¥Ïöî!");
    };
    document.getElementById("redoBtn").onclick = () => {
      if (redoStack.length === 0) return showToast("Îã§Ïãú Ïã§ÌñâÌï† ÏûëÏóÖÏù¥ ÏóÜÏñ¥Ïöî!");
      undoStack.push(getCurrentState());
      const next = redoStack.pop();
      applyState(next);
      showToast("Îã§Ïãú Ïã§ÌñâÌñàÏñ¥Ïöî!");
    };

    function changeDate(offset) {
      db.ref("attendance/Ïò®Ïú†Î∂Ä/" + currentDate).off();
      const d = new Date(currentDate);
      d.setDate(d.getDate() + offset);
      currentDate = d.toISOString().split("T")[0];
      datePicker._flatpickr.setDate(currentDate, true);
      fetchNames().then(() => { render(); listenToFirebase(); });
    }

    flatpickr(datePicker, {
      locale: "ko",
      dateFormat: "Y-m-d",
      defaultDate: currentDate,
      onChange: (_, dateStr) => {
        db.ref("attendance/Ïò®Ïú†Î∂Ä/" + currentDate).off();
        render();
        
        currentDate = dateStr;
        fetchNames().then(() => { render(); listenToFirebase(); });
      },
      onDayCreate: function(_,__,___,el) {
        const d = new Date(el.dateObj.getTime() - el.dateObj.getTimezoneOffset()*60000);
        const k = d.toISOString().split("T")[0];
        db.ref("attendance/" + k).get().then(s => {
          if (s.exists()) el.classList.add("attendance-day");
        });
      }
    });

    fetchNames().then(() => { render(); listenToFirebase(); });
  </script>
</body>
</html>
