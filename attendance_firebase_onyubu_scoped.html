<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDrHDHrYO2Z8tWmWRgWYcN4nWHwALZ4c0s",
    authDomain: "attendance-6b1b6.firebaseapp.com",
    databaseURL: "https://attendance-6b1b6-default-rtdb.firebaseio.com",
    projectId: "attendance-6b1b6",
    storageBucket: "attendance-6b1b6.firebasestorage.app",
    messagingSenderId: "808077953334",
    appId: "1:808077953334:web:238afede21744aee6f8b97",
    measurementId: "G-FZT4B2JQXH"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const brothers = ["양인수", "김호진", "이상수", "정형기", "박수용", "고병인", "이동길", "정인교", "권세빈", "김용빈", "김승후", "홍정의", "김민성", "하현성", "김진우", "전은섭"];
  const sisters = ["김유진", "이지희", "김민지", "임윤지", "박다은", "유재나", "김세연", "김채연", "임민해", "한예은", "임연주", "최연서", "한가은"];
  let currentDate = new Date().toISOString().split("T")[0];

  const datePicker = document.getElementById("datePicker");
  const summary = document.getElementById("summary");
  const broCountEl = document.getElementById("broCount");
  const sisCountEl = document.getElementById("sisCount");
  const brothersDiv = document.getElementById("brothers");
  const sistersDiv = document.getElementById("sisters");

  let undoStack = [];
  let redoStack = [];

  function getCurrentState() {
    return {
      형제: brothers.map((_, i) => brothersDiv.children[i].classList.contains("present")),
      자매: sisters.map((_, i) => sistersDiv.children[i].classList.contains("present"))
    };
  }

  function applyState(state) {
    state.형제.forEach((v, i) => brothersDiv.children[i]?.classList.toggle("present", v));
    state.자매.forEach((v, i) => sistersDiv.children[i]?.classList.toggle("present", v));
    updateSummary();
    saveToFirebase();
  }

  function pushUndoState() {
    undoStack.push(getCurrentState());
    redoStack = [];
  }

  function createTag(name, group) {
    const div = document.createElement("div");
    div.className = "name";
    div.textContent = name;
    div.onclick = () => {
      pushUndoState();
      div.classList.toggle("present");
      updateSummary();
      saveToFirebase();
    };
    return div;
  }

  function render() {
    brothersDiv.innerHTML = "";
    sistersDiv.innerHTML = "";
    brothers.forEach(name => brothersDiv.appendChild(createTag(name, "brother")));
    sisters.forEach(name => sistersDiv.appendChild(createTag(name, "sister")));
  }

  function updateSummary() {
    const b = [...brothersDiv.children].filter(c => c.classList.contains("present")).length;
    const s = [...sistersDiv.children].filter(c => c.classList.contains("present")).length;
    summary.textContent = `총 출석: ${b + s}명`;
    broCountEl.textContent = b ? `${b}명` : "";
    sisCountEl.textContent = s ? `${s}명` : "";
  }

  function saveToFirebase() {
    const bro = brothers.map((_, i) => brothersDiv.children[i].classList.contains("present"));
    const sis = sisters.map((_, i) => sistersDiv.children[i].classList.contains("present"));
    db.ref("attendance/온유부/" + currentDate).set({ 형제: bro, 자매: sis });
  }

  function loadFromFirebase() {
    render();
    db.ref("attendance/온유부/" + currentDate).get().then(snap => {
      if (!snap.exists()) return updateSummary();
      const data = snap.val();
      if (data.형제) data.형제.forEach((v,i) => brothersDiv.children[i]?.classList.toggle("present", v));
      if (data.자매) data.자매.forEach((v,i) => sistersDiv.children[i]?.classList.toggle("present", v));
      updateSummary();
    });
  }

  function copyToClipboard(text) {
    const textarea = document.createElement("textarea");
    textarea.value = text;
    textarea.setAttribute("readonly", "");
    textarea.style.position = "absolute";
    textarea.style.left = "-9999px";
    document.body.appendChild(textarea);
    textarea.select();
    try {
      const successful = document.execCommand("copy");
      showToast(successful ? "출석 현황 복사됨!" : "복사 실패!");
    } catch (err) {
      showToast("복사 중 오류 발생!");
    }
    document.body.removeChild(textarea);
  }

  function showToast(message) {
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.classList.add("show"), 10);
    setTimeout(() => {
      toast.classList.remove("show");
      setTimeout(() => document.body.removeChild(toast), 500);
    }, 2000);
  }

  document.getElementById("copyBtn").onclick = () => {
    const yy = currentDate.slice(2,4), mm = currentDate.slice(5,7), dd = currentDate.slice(8,10);
    const wd = ['일','월','화','수','목','금','토'][new Date(currentDate).getDay()];
    const bro = [...brothersDiv.children].filter(c => c.classList.contains("present")).map(c => c.textContent);
    const sis = [...sistersDiv.children].filter(c => c.classList.contains("present")).map(c => c.textContent);
    const lines = [`${yy}.${mm}.${dd}(${wd}) 온유부 총 ${bro.length + sis.length}명`];
    lines.push(`형제님 ${bro.length}명`);
    for (let i=0; i<bro.length; i+=5) lines.push(bro.slice(i,i+5).join(" "));
    lines.push(``, `자매님 ${sis.length}명`);
    for (let i=0; i<sis.length; i+=5) lines.push(sis.slice(i,i+5).join(" "));
    copyToClipboard(lines.join("\n"));
  };

  function changeDate(offset) {
    const d = new Date(currentDate);
    d.setDate(d.getDate() + offset);
    currentDate = d.toISOString().split("T")[0];
    datePicker._flatpickr.setDate(currentDate, true);
    loadFromFirebase();
  }

  document.getElementById("prevDay").onclick = () => changeDate(-1);
  document.getElementById("nextDay").onclick = () => changeDate(1);
  document.getElementById("clearAllBtn").onclick = () => {
    pushUndoState();
    [...brothersDiv.children].forEach(c => c.classList.remove("present"));
    [...sistersDiv.children].forEach(c => c.classList.remove("present"));
    updateSummary();
    saveToFirebase();
  };
  document.getElementById("undoBtn").onclick = () => {
    if (undoStack.length === 0) return showToast("되돌릴 작업이 없어요!");
    const prev = undoStack.pop();
    redoStack.push(getCurrentState());
    applyState(prev);
    showToast("되돌렸어요!");
  };
  document.getElementById("redoBtn").onclick = () => {
    if (redoStack.length === 0) return showToast("다시 실행할 작업이 없어요!");
    const next = redoStack.pop();
    undoStack.push(getCurrentState());
    applyState(next);
    showToast("다시 실행했어요!");
  };

  flatpickr(datePicker, {
    locale: "ko",
    dateFormat: "Y-m-d",
    defaultDate: currentDate,
    onChange: (_, dateStr) => {
      currentDate = dateStr;
      loadFromFirebase();
    },
    onDayCreate: function(_,__,___,el) {
      const d = new Date(el.dateObj.getTime() - el.dateObj.getTimezoneOffset()*60000);
      const k = d.toISOString().split("T")[0];
      db.ref("attendance/" + k).get().then(s => {
        if (s.exists()) el.classList.add("attendance-day");
      });
    }
  });

  loadFromFirebase();
</script>
